name: Test Release Workflow (E2E)

on:
  workflow_dispatch:
    inputs:
      test_commit:
        description: 'Test commit SHA (defaults to c2patool-v0.26.4 release)'
        required: false
        default: '17ad81b5750eee3be0a5c058054fa1492e8f29c4'
  push:
    branches:
      - 'mathern/release-fix-possibly'

permissions:
  contents: read

jobs:
  test-release-plz:
    name: Test Release-plz Job
    runs-on: ubuntu-latest

    outputs:
      c2patool-release-tag: ${{ steps.sniff-c2patool-release-tag.outputs.tag }}

    steps:
      - name: Test Info
        run: |
          echo "ðŸ§ª E2E TEST MODE"
          echo "==============="
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "Testing commit: ${{ inputs.test_commit }}"
          else
            echo "Testing commit: ${{ github.sha }}"
          fi
          echo "This workflow simulates the real release workflow"
          echo "but does NOT publish anything to production."
          echo ""

      - name: Checkout repository
        uses: actions/checkout@v5
        with:
          fetch-depth: 0
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.test_commit || '17ad81b5750eee3be0a5c058054fa1492e8f29c4' }}

      - name: Show current state BEFORE fetch
        run: |
          echo "=== Current State BEFORE fetch ==="
          echo "HEAD: $(git rev-parse HEAD)"
          echo "Short SHA: $(git rev-parse --short HEAD)"
          echo ""
          echo "Local tags (first 10):"
          git tag -l | head -10
          echo ""
          echo "Tags on current HEAD:"
          git tag --points-at HEAD || echo "(none)"
          echo ""
          echo "c2patool tags that contain HEAD:"
          git tag --contains HEAD | grep '^c2patool-' || echo "(none - THIS IS THE BUG)"
          echo "================================"

      - name: Fetch newly created tags
        run: |
          echo "=== THE FIX: Fetching tags from remote ==="
          git fetch --tags
          echo "Tags fetched successfully!"

      - name: Show current state AFTER fetch
        run: |
          echo "=== Current State AFTER fetch ==="
          echo "c2patool tags that contain HEAD:"
          git tag --contains HEAD | grep '^c2patool-' || echo "(still none - FIX FAILED)"
          echo ""
          echo "All tags on current HEAD:"
          git tag --points-at HEAD || echo "(none)"
          echo "================================"

      - name: Identify c2patool release
        id: sniff-c2patool-release-tag
        run: |
          echo "=== Detecting c2patool release tag ==="
          echo "All tags on HEAD:"
          git tag --contains HEAD
          echo ""
          echo "Filtered c2patool tags:"
          git tag --contains HEAD | grep '^c2patool-' || echo "No c2patool tags found"
          echo ""
          TAG=$(git tag --contains HEAD | grep '^c2patool-' || true)
          echo tag=$TAG >> "$GITHUB_OUTPUT"
          echo "Output tag: '${TAG}'"
          echo ""
          if [ -n "$TAG" ]; then
            echo "SUCCESS: Tag detected - binaries WOULD be built"
          else
            echo "FAIL: No tag detected - binaries would be SKIPPED"
          fi

  test-publish-c2patool-binaries:
    name: Test Publish c2patool binaries
    runs-on: ${{ matrix.os }}
    needs: test-release-plz

    strategy:
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]  # Only test on Linux for speed
        rust_version: [ stable ]

    steps:
      - name: Check if workflow would run
        run: |
          echo "=== Binary Build Job Check ==="
          TAG="${{ needs.test-release-plz.outputs.c2patool-release-tag }}"
          echo "c2patool-release-tag output: '$TAG'"
          echo ""
          if [ -n "$TAG" ]; then
            echo "This job WOULD run in production"
            echo "   Tag: $TAG"
            echo "   Build steps would execute"
          else
            echo "This job WOULD BE SKIPPED in production"
            echo "   No tag detected = no binaries built"
            exit 1
          fi

      - name: Checkout repository
        if: ${{ needs.test-release-plz.outputs.c2patool-release-tag }}
        uses: actions/checkout@v5
        with:
          ref: ${{ github.event_name == 'workflow_dispatch' && inputs.test_commit || '17ad81b5750eee3be0a5c058054fa1492e8f29c4' }}

      - name: Install Rust toolchain
        if: ${{ needs.test-release-plz.outputs.c2patool-release-tag }}
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: ${{ matrix.rust_version }}
          components: llvm-tools-preview

      - name: Cache Rust dependencies
        if: ${{ needs.test-release-plz.outputs.c2patool-release-tag }}
        uses: Swatinem/rust-cache@v2

      - name: Test build (dry run)
        if: ${{ needs.test-release-plz.outputs.c2patool-release-tag }}
        run: |
          echo "=== Testing Build ==="
          echo "In production, this would run: cd cli && make release"
          echo "For this test, we'll just verify we can build:"
          cd cli
          cargo build --release
          echo ""
          echo "Build succeeded!"
          ls -lh ../target/release/c2patool || echo "Binary location varies by OS"

      - name: Final test result
        if: ${{ needs.test-release-plz.outputs.c2patool-release-tag }}
        run: |
          echo "All done"

